# éŸ³è¨Šé…ç½®èªªæ˜

## âœ… å·²ä¿®å¾©çš„å•é¡Œ

### 1. éŸ³è¨Šæ’­æ”¾é€Ÿåº¦æ­£å¸¸
- **å•é¡Œ**ï¼šéŒ„ 5 ç§’æ’­æ”¾ 10 ç§’ï¼ˆæ…¢ä¸€å€ï¼‰
- **åŸå› **ï¼šInterleaved stereo æ ¼å¼ `(1, 1920)` æ¨£æœ¬æ•¸åŠ å€
- **ä¿®å¾©**ï¼šæ­£ç¢ºè™•ç† deinterleave ä¸¦å¹³å‡æˆ mono

### 2. éŸ³é‡å¢ç›ŠåŠŸèƒ½
- **æ–°å¢**ï¼šå¯èª¿æ•´éŸ³é‡æ”¾å¤§å€æ•¸
- **é è¨­**ï¼š2.0 å€ï¼ˆé›™å€éŸ³é‡ï¼‰
- **ç¯„åœ**ï¼šå»ºè­° 1.5 - 3.0

## ğŸ¯ çµ±ä¸€çš„éŸ³è¨Šè™•ç†

å…©å€‹éŒ„éŸ³é é¢ç¾åœ¨ä½¿ç”¨ç›¸åŒçš„éŸ³è¨Šè™•ç†é‚è¼¯ï¼š

### æ ¸å¿ƒå‡½æ•¸ï¼š`process_audio_frame()`
ä½ç½®ï¼š`src/services/audio_service.py`

åŠŸèƒ½ï¼š
1. âœ… è‡ªå‹•åµæ¸¬ä¸¦è™•ç† interleaved/planar stereo
2. âœ… æ­£ç¢ºè½‰æ›ç‚º monoï¼ˆæ¨£æœ¬æ•¸ä¸åŠ å€ï¼‰
3. âœ… ä¿æŒåŸå§‹æ¡æ¨£ç‡ï¼ˆ48kHzï¼‰
4. âœ… æ”¯æ´éŸ³é‡å¢ç›Š
5. âœ… é˜²æ­¢éŸ³è¨Šå‰Šæ³¢ï¼ˆclippingï¼‰

### ä½¿ç”¨çš„é é¢

#### 1. éº¥å…‹é¢¨éŒ„éŸ³æ¸¬è©¦é é¢ (`mic_recorder_page.py`)
```python
# Line 26: è¨­å®šéŸ³é‡å¢ç›Š
AUDIO_GAIN = 2.0  # é›™å€éŸ³é‡

# Line 129: ä½¿ç”¨éŸ³è¨Šè™•ç†
pcm_array = process_audio_frame(frame, gain=AUDIO_GAIN)
```

#### 2. å³æ™‚èªéŸ³è½‰éŒ„é é¢ (`transcription_page.py`)
```python
# Line 46: è¨­å®šéŸ³é‡å¢ç›Š
AUDIO_GAIN = 2.0  # é›™å€éŸ³é‡

# Line 452: ä½¿ç”¨éŸ³è¨Šè™•ç†
pcm = process_audio_frame(frame, gain=AUDIO_GAIN)
```

## ğŸ”§ èª¿æ•´éŸ³é‡

å¦‚éœ€èª¿æ•´éŸ³é‡å¢ç›Šï¼Œä¿®æ”¹å„é é¢çš„ `AUDIO_GAIN` å¸¸æ•¸ï¼š

```python
AUDIO_GAIN = 1.0   # åŸå§‹éŸ³é‡ï¼ˆç„¡å¢ç›Šï¼‰
AUDIO_GAIN = 1.5   # 1.5 å€éŸ³é‡ï¼ˆè¼•å¾®å¢å¼·ï¼‰
AUDIO_GAIN = 2.0   # 2 å€éŸ³é‡ï¼ˆæ¨è–¦ï¼Œé è¨­å€¼ï¼‰
AUDIO_GAIN = 3.0   # 3 å€éŸ³é‡ï¼ˆå¤§å¹…å¢å¼·ï¼‰
AUDIO_GAIN = 0.5   # æ¸›åŠéŸ³é‡ï¼ˆé™ä½ï¼‰
```

**æ³¨æ„**ï¼š
- å¢ç›Šéå¤§ï¼ˆ> 3.0ï¼‰å¯èƒ½å°è‡´éŸ³è¨Šå¤±çœŸï¼ˆå‰Šæ³¢ï¼‰
- ç¨‹å¼ç¢¼å·²è‡ªå‹•åŠ å…¥ clipping ä¿è­·ï¼ˆ-32768 ~ 32767ï¼‰

## ğŸ“Š æŠ€è¡“ç´°ç¯€

### Interleaved Stereo è™•ç†

**å•é¡Œæ ¼å¼**ï¼š
```
Shape: (1, 1920)
Expected samples: 960
Actual format: [L0, R0, L1, R1, L2, R2, ..., L959, R959]
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```python
# 1. Flatten: (1, 1920) â†’ (1920,)
pcm = pcm.squeeze(0)

# 2. Deinterleave and average: (1920,) â†’ (960,)
pcm = pcm.reshape(-1, 2).mean(axis=1)
```

**çµæœ**ï¼š
- æ¨£æœ¬æ•¸æ­£ç¢ºï¼š960 samples
- æ’­æ”¾é€Ÿåº¦æ­£å¸¸ï¼š5 ç§’éŒ„éŸ³ = 5 ç§’æ’­æ”¾ âœ…

### Planar Stereo è™•ç†

**æ ¼å¼**ï¼š
```
Shape: (2, 960)
Channel 0: [L0, L1, L2, ..., L959]
Channel 1: [R0, R1, R2, ..., R959]
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```python
# Average along axis 0
pcm = pcm.mean(axis=0)  # â†’ (960,)
```

### éŸ³é‡å¢ç›Šå¯¦ä½œ

```python
if gain != 1.0:
    # Convert to float for accurate multiplication
    pcm_float = pcm.astype(np.float32)
    pcm_float *= gain

    # Clip to prevent overflow and distortion
    pcm = np.clip(pcm_float, -32768, 32767).astype(np.int16)
```

## ğŸ§ª æ¸¬è©¦é©—è­‰

### 1. æ’­æ”¾é€Ÿåº¦æ¸¬è©¦
```bash
# éŒ„éŸ³ 5 ç§’ï¼ˆç”¨ç¢¼è¡¨è¨ˆæ™‚ï¼‰
# æ’­æ”¾æª”æ¡ˆæ‡‰è©²æ˜¯ 5 ç§’ âœ…
```

### 2. éŸ³é‡æ¸¬è©¦
```bash
# è¨­å®š AUDIO_GAIN = 2.0
# éŒ„éŸ³å¾Œæ’­æ”¾ï¼ŒéŸ³é‡æ‡‰è©²æ¯”åŸå§‹å¤§ä¸€å€ âœ…
```

### 3. éŸ³è³ªæ¸¬è©¦
```bash
# æª¢æŸ¥æ˜¯å¦æœ‰å‰Šæ³¢æˆ–å¤±çœŸ
# å¦‚æœæœ‰å‰Šæ³¢ï¼Œé™ä½ AUDIO_GAIN å€¼
```

## ğŸ“ æª¢æŸ¥æ¸…å–®

- [x] ä¿®å¾© interleaved stereo æ¨£æœ¬æ•¸åŠ å€å•é¡Œ
- [x] éŸ³è¨Šæ’­æ”¾é€Ÿåº¦æ­£å¸¸ï¼ˆéŒ„ 5 ç§’ = æ’­ 5 ç§’ï¼‰
- [x] æ·»åŠ éŸ³é‡å¢ç›ŠåŠŸèƒ½
- [x] å…©å€‹é é¢ä½¿ç”¨ç›¸åŒçš„éŸ³è¨Šè™•ç†é‚è¼¯
- [x] é˜²æ­¢éŸ³è¨Šå‰Šæ³¢ä¿è­·
- [x] ä¿æŒåŸå§‹æ¡æ¨£ç‡ï¼ˆ48kHzï¼‰

## ğŸ¤ ä½¿ç”¨å»ºè­°

1. **ä¸€èˆ¬ä½¿ç”¨**ï¼šä¿æŒ `AUDIO_GAIN = 2.0`
2. **éŒ„éŸ³å¤ªå°è²**ï¼šæé«˜åˆ° `2.5` æˆ– `3.0`
3. **éŒ„éŸ³å¤ªå¤§è²/å¤±çœŸ**ï¼šé™ä½åˆ° `1.5` æˆ– `1.0`
4. **éœ€è¦åŸå§‹éŸ³é‡**ï¼šè¨­ç‚º `1.0`

---

**ä¿®å¾©å®Œæˆæ—¥æœŸ**ï¼š2025-11-02
**æ¸¬è©¦ç‹€æ…‹**ï¼šâœ… é€šé
