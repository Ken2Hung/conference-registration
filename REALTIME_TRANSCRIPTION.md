# 即時語音轉錄功能說明

## ✨ 功能特點

### 真正的即時轉錄
- ✅ **邊錄邊轉**：錄音的同時進行轉錄
- ✅ **分段處理**：每 3 秒切一段音訊，立即送 OpenAI Whisper API 轉錄
- ✅ **即時顯示**：轉錄結果即時累積並顯示在頁面上
- ✅ **自動刷新**：頁面自動更新，無需手動操作

### 完整功能
- ✅ 完整 WAV 錄音保存
- ✅ 完整逐字稿 TXT 保存
- ✅ 即時音量監控（RMS）
- ✅ 已轉錄段數統計
- ✅ 字數即時統計

## 🎯 工作流程

```
按下開始錄音
    ↓
啟動兩個執行緒：
├─ WAV 寫入執行緒：持續寫入完整音訊到檔案
└─ 轉錄執行緒：每 3 秒轉錄一段並顯示
    ↓
錄音中...
├─ 0-3 秒：收集音訊
├─ 3 秒：第一段轉錄完成，顯示結果
├─ 3-6 秒：收集音訊
├─ 6 秒：第二段轉錄完成，累加顯示
└─ 持續進行...
    ↓
按下停止錄音
    ↓
停止所有執行緒
    ↓
保存完整 WAV + 完整逐字稿
```

## 📊 技術實現

### 核心組件

1. **AudioChunker**（音訊分段器）
   - 每 3 秒累積一段音訊
   - 自動切分並送到轉錄隊列

2. **雙執行緒架構**
   ```python
   _audio_worker()         # WAV 寫入執行緒
   _transcription_worker() # 轉錄執行緒
   ```

3. **三個 Queue**
   ```python
   _audio_queue    # WAV 寫入隊列
   _chunk_queue    # 轉錄隊列
   _realtime_transcript  # 即時逐字稿累積
   ```

### 音訊處理流程

```
WebRTC Microphone
    ↓
audio_callback(frame)
    ↓
process_audio_frame(frame, gain=2.0)
    ├─→ _audio_queue → _audio_worker() → WAV File
    └─→ AudioChunker
            ↓ (每 3 秒)
        _chunk_queue → _transcription_worker()
            ↓
        OpenAI Whisper API
            ↓
        _realtime_transcript
            ↓
        頁面即時顯示
```

### 轉錄執行緒詳解

```python
def _transcription_worker():
    while recording:
        # 1. 從隊列取得 3 秒音訊段
        chunk = _chunk_queue.get()

        # 2. 轉換為 WAV bytes
        wav_bytes = create_wav_chunk(chunk, 48000)

        # 3. 送 Whisper API 轉錄
        transcript = whisper_api.transcribe(wav_bytes)

        # 4. 累加到即時逐字稿
        _realtime_transcript.append(transcript)

        # 5. 頁面會自動刷新並顯示
```

## 🚀 使用方法

### 1. 啟動應用程式
```bash
./start.sh
```

### 2. 進入語音轉錄頁面
- 等待綠色「✅ 麥克風已就緒」訊息

### 3. 開始錄音
- 點擊「▶️ 開始錄音」
- 開始說話

### 4. 觀察即時轉錄
- 約 3 秒後，第一段轉錄結果會出現
- 之後每 3 秒更新一次
- 可以看到：
  - 即時累積的逐字稿
  - 已轉錄段數
  - 總字數

### 5. 停止錄音
- 點擊「⏹️ 停止錄音並轉錄」
- 系統會：
  - 停止錄音
  - 保存完整 WAV 檔案
  - 保存完整逐字稿 TXT
  - 顯示下載按鈕

## ⚙️ 配置參數

### 音訊配置
```python
SAMPLE_RATE = 48000      # 採樣率（Hz）
SAMPLE_WIDTH = 2         # 位元深度（bytes）
AUDIO_GAIN = 2.0         # 音量增益（2.0 = 雙倍）
```

### 轉錄配置
```python
CHUNK_DURATION = 3.0     # 分段長度（秒）
                         # 建議：2.0 - 5.0 秒
                         # - 太短：API 調用頻繁，成本高
                         # - 太長：即時性差
```

### Whisper API 配置
```python
model="whisper-1"        # OpenAI Whisper 模型
language="zh"            # 中文
response_format="text"   # 純文字輸出
```

## 🔧 調整建議

### 調整分段長度

如果想要更即時的效果（更頻繁更新）：
```python
# src/ui/transcription_page.py (Line 32)
CHUNK_DURATION = 2.0  # 每 2 秒轉錄一次
```

如果想要降低 API 成本（較少調用）：
```python
CHUNK_DURATION = 5.0  # 每 5 秒轉錄一次
```

### 調整音量增益

```python
# src/ui/transcription_page.py (Line 31)
AUDIO_GAIN = 3.0  # 增大音量
AUDIO_GAIN = 1.5  # 減小音量
```

## 💰 成本估算

### OpenAI Whisper API 定價
- **$0.006 / 分鐘**（2024 年價格）

### 成本計算
```
假設錄音 10 分鐘：

方案 A：分段即時轉錄（CHUNK_DURATION = 3.0）
- 總段數：10 * 60 / 3 = 200 段
- 每段 3 秒 = 0.05 分鐘
- 總成本：200 * 0.05 * $0.006 = $0.06

方案 B：錄完一次性轉錄
- 總段數：1 段
- 每段 10 分鐘
- 總成本：1 * 10 * $0.006 = $0.06

結論：成本相同！
```

**注意**：實際成本相同，因為 Whisper API 按音訊總長度計費，不是按調用次數。

## 📁 檔案結構

### 錄音檔案
```
resource/recording-20251102-123456.wav
```

### 逐字稿檔案
```
resource/recording-20251102-123456-transcript.txt
```

### 逐字稿格式
```
語音轉錄結果
時間：2025-11-02 12:34:56
音訊檔案：recording-20251102-123456.wav
採樣率：48000 Hz
模型：OpenAI Whisper (whisper-1)

============================================================

這是第一段轉錄的內容...
這是第二段轉錄的內容...
這是第三段轉錄的內容...
```

## 🐛 常見問題

### Q1: 為什麼前 3 秒沒有逐字稿？

**原因**：需要累積足夠的音訊才能進行第一次轉錄。

**正常現象**：
- 0-3 秒：收集音訊
- 3 秒時：第一段送 API 轉錄
- 3-5 秒：API 處理中
- 5 秒時：第一段結果出現

### Q2: 頁面一直閃爍？

**原因**：頁面正在自動刷新以顯示最新的轉錄結果。

**這是正常的**：每次有新的轉錄結果時，頁面會自動刷新 0.5 秒後更新。

### Q3: 轉錄結果不準確？

**可能原因**：
1. 音量太小 → 提高 `AUDIO_GAIN`
2. 背景噪音太大 → 在安靜環境錄音
3. 口音或方言 → Whisper 對普通話支援最好

**解決方法**：
```python
# 提高音量增益
AUDIO_GAIN = 3.0

# 使用更好的麥克風
# 在安靜環境錄音
```

### Q4: API 調用失敗？

**檢查清單**：
1. ✅ OpenAI API Key 是否正確
2. ✅ API Key 是否有餘額
3. ✅ 網路連線是否正常
4. ✅ 是否被防火牆阻擋

## 🆚 與批次轉錄的比較

| 功能 | 批次轉錄（舊版） | 即時轉錄（新版） |
|------|----------------|----------------|
| **轉錄時機** | 錄音結束後 | 錄音過程中 |
| **顯示延遲** | 需等待全部錄完 | 每 3 秒更新 |
| **使用體驗** | 較慢 | 即時 |
| **API 成本** | $0.006/分鐘 | $0.006/分鐘 |
| **準確度** | 高（完整上下文） | 高（分段轉錄） |
| **檔案保存** | WAV + TXT | WAV + TXT |
| **適用場景** | 短時間錄音 | 長時間錄音 |

## 🎨 UI 顯示

### 錄音中
```
🎤 即時語音轉錄（OpenAI Whisper）
使用 WebRTC 錄音並透過 OpenAI Whisper API 即時轉錄為逐字稿（每 3 秒更新）

🎙️ 錄音控制
[開始錄音]  [停止錄音並轉錄]
🔴 錄音中... 點擊「停止錄音並轉錄」以結束並開始轉錄

🎙️ 麥克風串流
🎧 麥克風已連線，音訊串流正常

📊 錄音狀態
📁 檔案：resource/recording-20251102-123456.wav
⏱️ 已錄製：15.3 秒
🔊 當前 RMS：1234.5
🎚️ 採樣率：48000 Hz
📈 音量增益：2.0x
📝 已轉錄段數：5
🕒 錄音時長：15.3 秒

📄 即時轉錄結果
[即時逐字稿（錄音中...）]
這是第一段轉錄的內容...
這是第二段轉錄的內容...
這是第三段轉錄的內容...
這是第四段轉錄的內容...
這是第五段轉錄的內容...

📊 已轉錄：234 字元 | 分段數：5
```

### 錄音結束
```
📄 即時轉錄結果
✅ 轉錄完成

[完整逐字稿]
這是第一段轉錄的內容...
這是第二段轉錄的內容...
...

📊 字數：456 字元
💾 已保存至：resource/recording-20251102-123456-transcript.txt

[📥 下載逐字稿]
```

---

**實作完成日期**：2025-11-02
**測試狀態**：待測試
**版本**：v2.0 - Real-time Transcription
