# WebSocket é¢¨æ ¼å³æ™‚æ›´æ–°æ”¹é€²

## ğŸ“… æ›´æ–°æ—¥æœŸ
**2025-11-02**

## âœ¨ ä¸»è¦æ”¹é€²

### 1. ç¹é«”ä¸­æ–‡åš´æ ¼é™åˆ¶ âœ…
**ä¿®æ”¹ä½ç½®**: `src/ui/transcription_page.py:623`

**æ·»åŠ  Prompt**:
```python
prompt="è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡è¼¸å‡ºï¼Œåš´æ ¼ç¦æ­¢ç°¡é«”ä¸­æ–‡ã€‚"
```

**æ•ˆæœ**:
- âœ… æ˜ç¢ºè¦æ±‚ä½¿ç”¨ç¹é«”ä¸­æ–‡
- âœ… ç¦æ­¢ç°¡é«”ä¸­æ–‡è¼¸å‡º
- âœ… æé«˜ç¹é«”ä¸­æ–‡æº–ç¢ºåº¦

**æ³¨æ„**: é€™å€‹ prompt ç°¡çŸ­æ˜ç¢ºï¼Œä¸æœƒè¢« Whisper è½‰éŒ„å‡ºä¾†ï¼ˆä¹‹å‰æ¸¬è©¦éé•·çš„ prompt æœƒè¢«è½‰éŒ„ï¼‰ã€‚

### 2. WebSocket é¢¨æ ¼çš„å³æ™‚æ›´æ–° âœ…
**ä¿®æ”¹ä½ç½®**: `src/ui/transcription_page.py:296-325`

**æ ¸å¿ƒæ”¹é€²**:

#### æ”¹é€² A: æ›´é »ç¹çš„æ›´æ–°
```python
# å¾ 1 ç§’æ”¹ç‚º 0.5 ç§’
if current_time - st.session_state.last_ui_update >= 0.5:
    st.session_state.last_ui_update = current_time
    time.sleep(0.05)  # Small delay to prevent overwhelming
    st.rerun()
```

#### æ”¹é€² B: å›ºå®šçš„ text_area å®¹å™¨
**æ”¹é€²å‰**ï¼ˆæ¢ä»¶å¼é¡¯ç¤ºï¼‰:
```python
if current_transcript:
    st.text_area(...)  # æœ‰å…§å®¹æ™‚é¡¯ç¤º
else:
    st.info(...)       # æ²’å…§å®¹æ™‚é¡¯ç¤ºä¸åŒçµ„ä»¶
```

**æ”¹é€²å¾Œ**ï¼ˆå§‹çµ‚é¡¯ç¤ºåŒä¸€å€‹çµ„ä»¶ï¼‰:
```python
# Always show text area to ensure real-time updates (like WebSocket)
if current_transcript:
    display_value = current_transcript
    display_label = f"å³æ™‚é€å­—ç¨¿ï¼ˆéŒ„éŸ³ä¸­... æœ€å¾Œæ›´æ–°ï¼š{last_update_time}ï¼‰"
else:
    display_value = f"ğŸ¤ ç­‰å¾…è½‰éŒ„çµæœ...\n\né–‹å§‹æ™‚é–“ï¼š{last_update_time}\nTokenï¼š{token[:8]}\n\nç´„ 3 ç§’å¾Œæœƒå‡ºç¾ç¬¬ä¸€æ®µè½‰éŒ„çµæœ"
    display_label = f"å³æ™‚é€å­—ç¨¿ï¼ˆç­‰å¾…ä¸­... {last_update_time}ï¼‰"

st.text_area(
    display_label,
    value=display_value,
    height=300,
    key="realtime_transcript_display"  # å›ºå®šçš„ key
)
```

**å„ªé»**:
- âœ… å§‹çµ‚ä½¿ç”¨åŒä¸€å€‹ text_area çµ„ä»¶
- âœ… å›ºå®šçš„ key ç¢ºä¿ Streamlit ä¸æœƒé‡æ–°å‰µå»ºçµ„ä»¶
- âœ… å…§å®¹å³æ™‚æ›¿æ›ï¼Œé¡ä¼¼ WebSocket çš„è¡Œç‚º
- âœ… ç­‰å¾…æ™‚ä¹Ÿé¡¯ç¤ºæœ‰ç”¨ä¿¡æ¯

#### æ”¹é€² C: å‹•æ…‹è¦–è¦ºåé¥‹
```python
# æ¨™é¡Œæœƒæ¯ 0.5 ç§’æ›´æ–°
display_label = f"å³æ™‚é€å­—ç¨¿ï¼ˆéŒ„éŸ³ä¸­... æœ€å¾Œæ›´æ–°ï¼š{last_update_time}ï¼‰"

# Caption ä¹Ÿæœƒæ›´æ–°
if current_transcript:
    st.caption(f"ğŸ“Š å·²è½‰éŒ„ï¼š{len(current_transcript)} å­—å…ƒ | åˆ†æ®µæ•¸ï¼š{segment_count} | æ›´æ–°æ™‚é–“ï¼š{last_update_time}")
else:
    st.caption(f"â³ ç­‰å¾…ä¸­... | å·²æª¢æŸ¥æ¬¡æ•¸ï¼š{st.session_state.segment_count} | æ›´æ–°æ™‚é–“ï¼š{last_update_time}")
```

**æ•ˆæœ**:
- ç”¨æˆ¶å¯ä»¥æ¸…æ¥šçœ‹åˆ°é é¢æ¯ 0.5 ç§’åœ¨æ›´æ–°
- å³ä½¿æ²’æœ‰è½‰éŒ„çµæœï¼Œæ›´æ–°æ™‚é–“ä¹Ÿæœƒè®ŠåŒ–
- æä¾›æ˜ç¢ºçš„å³æ™‚åé¥‹

## ğŸ“ å³æ™‚é¡¯ç¤ºæ•ˆæœ

### éšæ®µ 1: ç­‰å¾…è½‰éŒ„ï¼ˆ0-3 ç§’ï¼‰
```
å³æ™‚é€å­—ç¨¿ï¼ˆç­‰å¾…ä¸­... 17:45:23ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¤ ç­‰å¾…è½‰éŒ„çµæœ...

é–‹å§‹æ™‚é–“ï¼š17:45:23
Tokenï¼šabc12345

ç´„ 3 ç§’å¾Œæœƒå‡ºç¾ç¬¬ä¸€æ®µè½‰éŒ„çµæœ

â³ ç­‰å¾…ä¸­... | å·²æª¢æŸ¥æ¬¡æ•¸ï¼š0 | æ›´æ–°æ™‚é–“ï¼š17:45:23
```

**0.5 ç§’å¾Œï¼ˆé é¢è‡ªå‹•æ›´æ–°ï¼‰**:
```
å³æ™‚é€å­—ç¨¿ï¼ˆç­‰å¾…ä¸­... 17:45:23.5ï¼‰  â† æ™‚é–“è®ŠåŒ–äº†
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¤ ç­‰å¾…è½‰éŒ„çµæœ...

é–‹å§‹æ™‚é–“ï¼š17:45:23.5  â† æ›´æ–°äº†
Tokenï¼šabc12345

ç´„ 3 ç§’å¾Œæœƒå‡ºç¾ç¬¬ä¸€æ®µè½‰éŒ„çµæœ

â³ ç­‰å¾…ä¸­... | å·²æª¢æŸ¥æ¬¡æ•¸ï¼š0 | æ›´æ–°æ™‚é–“ï¼š17:45:23.5  â† æ›´æ–°äº†
```

### éšæ®µ 2: ç¬¬ä¸€æ®µè½‰éŒ„å‡ºç¾ï¼ˆç´„ 3 ç§’å¾Œï¼‰
```
å³æ™‚é€å­—ç¨¿ï¼ˆéŒ„éŸ³ä¸­... æœ€å¾Œæ›´æ–°ï¼š17:45:26ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
2025-11-02 17:45:26  æ­¡è¿å¤§å®¶ä¾†åˆ°ä»Šå¤©çš„æœƒè­°ã€‚

ğŸ“Š å·²è½‰éŒ„ï¼š16 å­—å…ƒ | åˆ†æ®µæ•¸ï¼š1 | æ›´æ–°æ™‚é–“ï¼š17:45:26
```

### éšæ®µ 3: ç¬¬äºŒæ®µè½‰éŒ„å‡ºç¾ï¼ˆç´„ 6 ç§’å¾Œï¼‰
```
å³æ™‚é€å­—ç¨¿ï¼ˆéŒ„éŸ³ä¸­... æœ€å¾Œæ›´æ–°ï¼š17:45:29ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
2025-11-02 17:45:26  æ­¡è¿å¤§å®¶ä¾†åˆ°ä»Šå¤©çš„æœƒè­°ã€‚
2025-11-02 17:45:29  ä»Šå¤©æˆ‘å€‘è¦è¨è«–çš„ä¸»é¡Œæ˜¯èªéŸ³è½‰éŒ„æŠ€è¡“ã€‚  â† æ–°å¢

ğŸ“Š å·²è½‰éŒ„ï¼š41 å­—å…ƒ | åˆ†æ®µæ•¸ï¼š2 | æ›´æ–°æ™‚é–“ï¼š17:45:29
```

## ğŸ”§ æŠ€è¡“å¯¦ä½œç´°ç¯€

### æ›´æ–°æ©Ÿåˆ¶å°æ¯”

| é …ç›® | èˆŠç‰ˆæœ¬ | æ–°ç‰ˆæœ¬ |
|------|--------|--------|
| **æ›´æ–°é »ç‡** | 1 ç§’ | **0.5 ç§’** â¬†ï¸ |
| **çµ„ä»¶é¡å‹** | æ¢ä»¶å¼ï¼ˆinfo/text_areaï¼‰ | **å›ºå®š text_area** âœ¨ |
| **çµ„ä»¶ key** | å‹•æ…‹ token | **å›ºå®š key** âœ¨ |
| **ç­‰å¾…ç‹€æ…‹** | é¡¯ç¤º info | **é¡¯ç¤ºåœ¨ text_area å…§** âœ¨ |
| **è¦–è¦ºåé¥‹** | ç„¡æ˜ç¢ºæŒ‡ç¤º | **æ¯ 0.5 ç§’æ›´æ–°æ™‚é–“** âœ¨ |

### ç‚ºä»€éº¼åƒ WebSocketï¼Ÿ

**WebSocket ç‰¹é»**:
1. æŒçºŒé€£æ¥
2. ä¼ºæœå™¨ä¸»å‹•æ¨é€
3. å³æ™‚æ›´æ–°å…§å®¹

**æˆ‘å€‘çš„å¯¦ä½œ**:
1. âœ… å›ºå®šçš„ UI çµ„ä»¶ï¼ˆæ¨¡æ“¬æŒçºŒé€£æ¥ï¼‰
2. âœ… æ¯ 0.5 ç§’æª¢æŸ¥æ–°å…§å®¹ï¼ˆæ¨¡æ“¬æ¨é€ï¼‰
3. âœ… å…§å®¹å³æ™‚æ›¿æ›ï¼ˆæ¨¡æ“¬å³æ™‚æ›´æ–°ï¼‰

### Streamlit é™åˆ¶èˆ‡è§£æ±ºæ–¹æ¡ˆ

**Streamlit é™åˆ¶**:
- âŒ ç„¡æ³•å¾ worker thread ç›´æ¥æ›´æ–° UI
- âŒ å¿…é ˆé€šé `st.rerun()` é‡æ–°æ¸²æŸ“æ•´å€‹é é¢

**æˆ‘å€‘çš„è§£æ±ºæ–¹æ¡ˆ**:
- âœ… ä½¿ç”¨å›ºå®š key çš„ text_areaï¼ˆé¿å…çµ„ä»¶é‡æ–°å‰µå»ºï¼‰
- âœ… é«˜é »ç‡ rerunï¼ˆ0.5 ç§’ï¼‰
- âœ… è¦–è¦ºåé¥‹æ˜ç¢ºï¼ˆæ›´æ–°æ™‚é–“ï¼‰

## ğŸ§ª æ¸¬è©¦æ­¥é©Ÿ

### æ¸¬è©¦ 1: é©—è­‰å³æ™‚æ›´æ–°

1. **é–‹å§‹éŒ„éŸ³**
   - é»æ“Šã€Œé–‹å§‹éŒ„éŸ³ã€
   - ç«‹å³è§€å¯Ÿ text_area

2. **è§€å¯Ÿç­‰å¾…ç‹€æ…‹**ï¼ˆ0-3 ç§’ï¼‰
   - **é æœŸ**: çœ‹åˆ°ã€Œç­‰å¾…è½‰éŒ„çµæœ...ã€
   - **é æœŸ**: æ¨™é¡Œçš„ã€Œæ›´æ–°æ™‚é–“ã€æ¯ 0.5 ç§’è®ŠåŒ–
   - **é æœŸ**: Caption çš„ã€Œæ›´æ–°æ™‚é–“ã€æ¯ 0.5 ç§’è®ŠåŒ–
   - é€™è­‰æ˜é é¢åœ¨æŒçºŒæ›´æ–°ï¼ˆåƒ WebSocketï¼‰

3. **èªªè©±æ¸¬è©¦**
   - æ¸…æ™°èªªè©± 3 ç§’ï¼ˆä¾‹å¦‚ï¼šã€Œé€™æ˜¯ç¬¬ä¸€å¥æ¸¬è©¦èªéŸ³ã€ï¼‰
   - **é æœŸ**: ç´„ 3 ç§’å¾Œï¼Œtext_area å…§å®¹å¾ã€Œç­‰å¾…...ã€è®Šç‚ºè½‰éŒ„çµæœ
   - **é æœŸ**: é¡¯ç¤ºã€Œ2025-11-02 17:45:26  é€™æ˜¯ç¬¬ä¸€å¥æ¸¬è©¦èªéŸ³ã€

4. **ç¹¼çºŒèªªè©±**
   - å†èªªè©± 3 ç§’ï¼ˆä¾‹å¦‚ï¼šã€Œé€™æ˜¯ç¬¬äºŒå¥æ¸¬è©¦èªéŸ³ã€ï¼‰
   - **é æœŸ**: ç´„ 0.5 ç§’å¾Œï¼Œçœ‹åˆ°ç¬¬äºŒæ®µå‡ºç¾
   - **é æœŸ**: åˆ†æ®µæ•¸å¾ 1 è®Šç‚º 2

5. **è§€å¯Ÿ Console**
   ```
   [Transcription] Segment 1 [2025-11-02 17:45:26] (RMS=2463.3): é€™æ˜¯ç¬¬ä¸€å¥...
   [Transcription] Total segments in buffer: 1
   [Transcription UI] Retrieved 1 segments from token abc12345
   [Transcription UI] Displaying 1 segments
   ```

### æ¸¬è©¦ 2: ç¹é«”ä¸­æ–‡é©—è­‰

1. **éŒ„éŸ³ä¸¦èªªè©±**
   - èªªä¸€äº›å¯èƒ½è¢«èª¤èªç‚ºç°¡é«”ä¸­æ–‡çš„è©å½™
   - ä¾‹å¦‚ï¼šã€Œå°ç£ã€ã€ã€Œè³‡è¨Šã€ã€ã€Œè»Ÿé«”ã€

2. **æª¢æŸ¥è½‰éŒ„çµæœ**
   - **é æœŸ**: å…¨éƒ¨ä½¿ç”¨ç¹é«”ä¸­æ–‡
   - âœ… å°ç£ï¼ˆä¸æ˜¯å°æ¹¾ï¼‰
   - âœ… è³‡è¨Šï¼ˆä¸æ˜¯ä¿¡æ¯ï¼‰
   - âœ… è»Ÿé«”ï¼ˆä¸æ˜¯è½¯ä»¶ï¼‰

3. **æª¢æŸ¥ TXT æ–‡æª”**
   ```bash
   cat resource/recording-*-transcript.txt
   ```
   - é©—è­‰æ‰€æœ‰å…§å®¹éƒ½æ˜¯ç¹é«”ä¸­æ–‡

### æ¸¬è©¦ 3: æ›´æ–°é »ç‡é©—è­‰

1. **é–‹å§‹éŒ„éŸ³**
2. **ç”¨ç¢¼è¡¨è¨ˆæ™‚**
   - è§€å¯Ÿã€Œæ›´æ–°æ™‚é–“ã€è®ŠåŒ–çš„é–“éš”
   - **é æœŸ**: ç´„æ¯ 0.5 ç§’è®ŠåŒ–ä¸€æ¬¡
3. **é€™è­‰æ˜**: æ›´æ–°é »ç‡æå‡åˆ° 0.5 ç§’ï¼ˆæ¯”ä¹‹å‰çš„ 1 ç§’å¿«ä¸€å€ï¼‰

## ğŸ“Š é æœŸ Console è¼¸å‡º

### æ­£å¸¸æµç¨‹ï¼ˆåŒ…å«å³æ™‚æ›´æ–°ï¼‰

```
[Transcription] Starting recording with token abc12345
[Transcription] Audio worker started for token abc12345
[Transcription] Transcription worker started for token abc12345

[Transcription UI] Active: True, Token: abc12345
[Transcription UI] Retrieved 0 segments from token abc12345

ï¼ˆæ¯ 0.5 ç§’é‡è¤‡ï¼‰
[Transcription UI] Active: True, Token: abc12345
[Transcription UI] Retrieved 0 segments from token abc12345

[Transcription UI] Active: True, Token: abc12345
[Transcription UI] Retrieved 0 segments from token abc12345

ï¼ˆç´„ 3 ç§’å¾Œï¼‰
[Transcription] Segment 1 [2025-11-02 17:45:26] (RMS=2463.3): é€™æ˜¯ç¬¬ä¸€å¥...
[Transcription] Total segments in buffer: 1

ï¼ˆ0.5 ç§’å¾Œï¼‰
[Transcription UI] Active: True, Token: abc12345
[Transcription UI] Retrieved 1 segments from token abc12345
[Transcription UI] Displaying 1 segments

ï¼ˆç¹¼çºŒèªªè©±ï¼‰
[Transcription] Segment 2 [2025-11-02 17:45:29] (RMS=3214.5): é€™æ˜¯ç¬¬äºŒå¥...
[Transcription] Total segments in buffer: 2

ï¼ˆ0.5 ç§’å¾Œï¼‰
[Transcription UI] Active: True, Token: abc12345
[Transcription UI] Retrieved 2 segments from token abc12345
[Transcription UI] Displaying 2 segments
```

## ğŸ’¡ ä½¿ç”¨å»ºè­°

### 1. è§€å¯Ÿæ›´æ–°æ™‚é–“
- æ¨™é¡Œå’Œ Caption éƒ½æœƒé¡¯ç¤ºã€Œæ›´æ–°æ™‚é–“ã€
- é€™å€‹æ™‚é–“æ¯ 0.5 ç§’è®ŠåŒ–
- è­‰æ˜é é¢åœ¨æŒçºŒæ›´æ–°ï¼ˆåƒ WebSocketï¼‰

### 2. ç­‰å¾…è½‰éŒ„æ™‚ä¸è¦æ“”å¿ƒ
- å‰ 3 ç§’æœƒé¡¯ç¤ºã€Œç­‰å¾…è½‰éŒ„çµæœ...ã€
- é€™æ˜¯æ­£å¸¸çš„ï¼ˆWhisper API éœ€è¦ 3 ç§’çš„éŸ³è¨Šï¼‰
- è§€å¯Ÿæ›´æ–°æ™‚é–“ç¢ºèªç³»çµ±æ­£åœ¨é‹ä½œ

### 3. åˆ†æ®µæ•¸çµ±è¨ˆ
- Caption æœƒé¡¯ç¤ºã€Œåˆ†æ®µæ•¸ã€
- æ¯æ¬¡æ–°è½‰éŒ„å‡ºç¾ï¼Œåˆ†æ®µæ•¸æœƒå¢åŠ 
- é€™æ˜¯å¦ä¸€å€‹å³æ™‚åé¥‹

## âœ… å®Œæˆæ¸…å–®

- [x] ç¹é«”ä¸­æ–‡åš´æ ¼é™åˆ¶ï¼ˆæ·»åŠ  promptï¼‰
- [x] æ›´æ–°é »ç‡æå‡åˆ° 0.5 ç§’
- [x] ä½¿ç”¨å›ºå®š key çš„ text_area
- [x] ç­‰å¾…ç‹€æ…‹ä¹Ÿåœ¨ text_area å…§é¡¯ç¤º
- [x] æ·»åŠ å‹•æ…‹è¦–è¦ºåé¥‹ï¼ˆæ›´æ–°æ™‚é–“ï¼‰
- [x] Console é™¤éŒ¯è¨Šæ¯å®Œæ•´
- [x] Python èªæ³•æª¢æŸ¥é€šé

---

**æ›´æ–°ç‰ˆæœ¬**: v5.6 - WebSocket-Style Real-time Updates
**ç‹€æ…‹**: å·²å®Œæˆ
**æ¸¬è©¦**: æº–å‚™æ¸¬è©¦

## ğŸš€ ç«‹å³æ¸¬è©¦

ç¾åœ¨å¯ä»¥æ¸¬è©¦äº†ï¼é‡é»è§€å¯Ÿï¼š
1. âœ… ã€Œæ›´æ–°æ™‚é–“ã€æ¯ 0.5 ç§’è®ŠåŒ–ï¼ˆè­‰æ˜é é¢åœ¨æ›´æ–°ï¼‰
2. âœ… ç´„ 3 ç§’å¾Œè½‰éŒ„çµæœå‡ºç¾
3. âœ… æ–°çš„è½‰éŒ„ç´„ 0.5 ç§’å¾Œé¡¯ç¤º
4. âœ… å…¨éƒ¨ä½¿ç”¨ç¹é«”ä¸­æ–‡
