# Bug ä¿®å¾©å ±å‘Š - 2025-11-02

## ğŸ› å•é¡Œå ±å‘Š

### å•é¡Œ 1: Whisper æŠŠ Prompt å…§å®¹è½‰éŒ„å‡ºä¾†
**ç—‡ç‹€**:
```
[Transcription] Segment 8 (RMS=2463.3): è«‹æº–ç¢ºè½‰éŒ„ï¼Œä¸è¦åœ¨éœéŸ³æˆ–èƒŒæ™¯å™ªéŸ³æ™‚ç”¢ç”Ÿæ–‡å­—ã€‚
[Transcription] Segment 9 (RMS=6497.8): è«‹æº–ç¢ºè½‰éŒ„ï¼Œä¸è¦åœ¨éœéŸ³æˆ–èƒŒæ™¯å™ªéŸ³æ™‚ç”¢ç”Ÿæ–‡å­—ã€‚
```

**æ ¹æœ¬åŸå› **:
- Whisper API çš„ `prompt` åƒæ•¸æ˜¯ç”¨ä¾†æä¾›ã€Œä¸Šä¸‹æ–‡ç¯„ä¾‹ã€ï¼Œè€Œéã€ŒæŒ‡ä»¤ã€
- ç•¶ prompt åŒ…å«çš„æ–‡å­—èˆ‡éŸ³è¨Šå…§å®¹ç›¸ä¼¼ï¼ŒWhisper å¯èƒ½æœƒç›´æ¥è¼¸å‡º prompt çš„å…§å®¹
- åŸå§‹ prompt: `"ä»¥ä¸‹æ˜¯ç¹é«”ä¸­æ–‡çš„èªéŸ³å…§å®¹ã€‚è«‹æº–ç¢ºè½‰éŒ„ï¼Œä¸è¦åœ¨éœéŸ³æˆ–èƒŒæ™¯å™ªéŸ³æ™‚ç”¢ç”Ÿæ–‡å­—ã€‚"`
- é€™ç¨®æŒ‡ä»¤æ€§æ–‡å­—ä¸æ‡‰è©²æ”¾åœ¨ prompt åƒæ•¸ä¸­

**Whisper API prompt åƒæ•¸çš„æ­£ç¢ºç”¨é€”**:
- âœ… æä¾›å‰æ–‡ä¸Šä¸‹æ–‡
- âœ… å¹«åŠ©è­˜åˆ¥å°ˆæœ‰åè©ã€è¡“èª
- âœ… æ”¹å–„è½‰éŒ„é€£è²«æ€§
- âœ… æä¾›é¢¨æ ¼ç¯„ä¾‹
- âŒ **ä¸æ˜¯ç”¨ä¾†çµ¦æ¨¡å‹ä¸‹æŒ‡ä»¤**

### å•é¡Œ 2: æŒ‰ä¸‹ã€Œé–‹å§‹éŒ„éŸ³ã€å¾Œç”¢ç”Ÿå¤šå€‹ Token
**ç—‡ç‹€**:
```
[Transcription] Starting recording with token b8f318c4
[Transcription] Starting recording with token 9c79a7a3
[Transcription] Starting recording with token 38f6c2e9
[Transcription] Starting recording with token 62ca509a
```

åŒæ™‚ä¼´éš¨å¤§é‡çš„ Streamlit rerun è¨Šæ¯ï¼š
```
Running script RerunData(page_script_hash='...')
Removing orphaned files...
Disconnecting files for session with ID ...
```

**æ ¹æœ¬åŸå› **:
- `_start_recording()` å‡½æ•¸æ²’æœ‰æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰ active token
- Streamlit çš„ rerun æ©Ÿåˆ¶å¯èƒ½å°è‡´å‡½æ•¸è¢«å¤šæ¬¡èª¿ç”¨
- æ¯æ¬¡èª¿ç”¨éƒ½å‰µå»ºæ–°çš„ token å’Œ worker threads
- é€ æˆè³‡æºæµªè²»å’Œæ½›åœ¨çš„æª”æ¡ˆè¡çª

## âœ… ä¿®å¾©æ–¹æ¡ˆ

### ä¿®å¾© 1: ç§»é™¤ Prompt ä¸­çš„æŒ‡ä»¤æ€§æ–‡å­—

**ä¿®æ”¹ä½ç½®**: `src/ui/transcription_page.py:583-591`

**ä¿®æ”¹å‰**:
```python
# Add Traditional Chinese prompt to improve accuracy and prevent hallucinations
transcript = client.audio.transcriptions.create(
    model="whisper-1",
    file=wav_file,
    language="zh",
    response_format="text",
    prompt="ä»¥ä¸‹æ˜¯ç¹é«”ä¸­æ–‡çš„èªéŸ³å…§å®¹ã€‚è«‹æº–ç¢ºè½‰éŒ„ï¼Œä¸è¦åœ¨éœéŸ³æˆ–èƒŒæ™¯å™ªéŸ³æ™‚ç”¢ç”Ÿæ–‡å­—ã€‚"
)
```

**ä¿®æ”¹å¾Œ**:
```python
# Transcribe with Traditional Chinese language setting
# Note: Using language="zh" without prompt to avoid hallucinations
# VAD filtering already handles silence detection at code level
transcript = client.audio.transcriptions.create(
    model="whisper-1",
    file=wav_file,
    language="zh",
    response_format="text"
)
```

**èªªæ˜**:
- å®Œå…¨ç§»é™¤ `prompt` åƒæ•¸
- ä¿ç•™ `language="zh"` ä¾†æŒ‡å®šä¸­æ–‡è½‰éŒ„
- éœéŸ³éæ¿¾å·²ç¶“ç”± VADï¼ˆVoice Activity Detectionï¼‰åœ¨ä»£ç¢¼å±¤é¢è™•ç†
- é¿å… prompt å…§å®¹è¢«èª¤è½‰éŒ„

### ä¿®å¾© 2: é˜²æ­¢é‡è¤‡å•Ÿå‹•éŒ„éŸ³

**ä¿®æ”¹ä½ç½®**: `src/ui/transcription_page.py:322-330`

**ä¿®æ”¹å‰**:
```python
def _start_recording() -> None:
    """Start recording and transcription."""
    global _active_token

    # Create new token
    token = str(uuid.uuid4())
```

**ä¿®æ”¹å¾Œ**:
```python
def _start_recording() -> None:
    """Start recording and transcription."""
    global _active_token

    # Prevent multiple simultaneous recordings
    with _recorder_lock:
        if _active_token is not None:
            print(f"[Transcription] Already recording with token {_active_token[:8]}, ignoring duplicate start request")
            return

    # Create new token
    token = str(uuid.uuid4())
```

**èªªæ˜**:
- åœ¨å‡½æ•¸é–‹é ­æª¢æŸ¥ `_active_token` æ˜¯å¦å·²å­˜åœ¨
- ä½¿ç”¨ `_recorder_lock` ç¢ºä¿åŸ·è¡Œç·’å®‰å…¨
- å¦‚æœå·²ç¶“åœ¨éŒ„éŸ³ï¼Œæ‰“å°æ—¥èªŒä¸¦ç›´æ¥è¿”å›
- é˜²æ­¢å‰µå»ºå¤šå€‹ä¸¦ç™¼çš„éŒ„éŸ³ session

## ğŸ“Š ä¿®å¾©é©—è­‰

### æ¸¬è©¦æ­¥é©Ÿ 1: é©—è­‰ Prompt ä¸æœƒè¢«è½‰éŒ„
1. å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼ä¸¦é€²å…¥ã€ŒèªéŸ³è½‰éŒ„ã€é é¢
2. é–‹å§‹éŒ„éŸ³ä¸¦èªªè©±
3. è§€å¯Ÿ console è¼¸å‡ºçš„è½‰éŒ„çµæœ
4. **é æœŸçµæœ**: ä¸æ‡‰è©²å‡ºç¾ã€Œè«‹æº–ç¢ºè½‰éŒ„ï¼Œä¸è¦åœ¨éœéŸ³æˆ–èƒŒæ™¯å™ªéŸ³æ™‚ç”¢ç”Ÿæ–‡å­—ã€ç­‰ prompt å…§å®¹

### æ¸¬è©¦æ­¥é©Ÿ 2: é©—è­‰ä¸æœƒç”¢ç”Ÿå¤šå€‹ Token
1. é»æ“Šã€Œé–‹å§‹éŒ„éŸ³ã€æŒ‰éˆ•
2. è§€å¯Ÿ console è¼¸å‡º
3. **é æœŸçµæœ**:
   - åªçœ‹åˆ°ä¸€æ¬¡ `[Transcription] Starting recording with token xxx`
   - å¦‚æœé‡è¤‡é»æ“Šï¼Œæ‡‰è©²çœ‹åˆ° `Already recording with token xxx, ignoring duplicate start request`
   - ä¸æœƒçœ‹åˆ°å¤šå€‹ä¸åŒçš„ token

### é æœŸ Console æ—¥èªŒï¼ˆæ­£å¸¸æµç¨‹ï¼‰
```
[Transcription] Starting recording with token 9c79a7a3
[Transcription] WAV path: resource/recording-20251102-173500.wav
[Transcription] Audio worker started for token 9c79a7a3
[Transcription] Transcription worker started for token 9c79a7a3
[Transcription] Opening WAV file: resource/recording-20251102-173500.wav
[Transcription] First chunk written, RMS=1234.5
[Transcription] Skipping silent chunk (RMS=89.3 < 300.0)
[Transcription] Segment 1 (RMS=2463.3): é€™æ˜¯æ¸¬è©¦èªéŸ³å…§å®¹ã€‚  â† æ­£ç¢ºçš„è½‰éŒ„çµæœ
[Transcription] Segment 2 (RMS=6497.8): ç¹¼çºŒèªªè©±çš„å…§å®¹ã€‚    â† æ­£ç¢ºçš„è½‰éŒ„çµæœ
[Transcription] Stopping recording for token 9c79a7a3
[Transcription] WAV file closed: resource/recording-20251102-173500.wav
[Transcription] Transcript saved: resource/recording-20251102-173500-transcript.txt
```

## ğŸ” æŠ€è¡“ç´°ç¯€

### Whisper API Prompt åƒæ•¸çš„è¨­è¨ˆæ„åœ–

æ ¹æ“š OpenAI æ–‡æª”ï¼Œ`prompt` åƒæ•¸çš„ç”¨é€”ï¼š
- æä¾›éŸ³è¨Šçš„ä¸Šä¸‹æ–‡æˆ–èƒŒæ™¯ä¿¡æ¯
- å¹«åŠ©æ¨¡å‹ç†è§£å°ˆæœ‰åè©ã€è¡“èªã€ç¸®å¯«
- å»¶çºŒä¹‹å‰çš„è½‰éŒ„å…§å®¹ï¼ˆæé«˜é€£è²«æ€§ï¼‰

**å¥½çš„ Prompt ç¯„ä¾‹**:
```python
# æä¾›å°ˆæœ‰åè©ä¸Šä¸‹æ–‡
prompt="æœƒè­°è¨è«–é—œæ–¼ Streamlitã€WebRTCã€OpenAI API çš„æŠ€è¡“æ•´åˆã€‚"

# å»¶çºŒä¹‹å‰çš„è½‰éŒ„
prompt="å‰ä¸€æ®µçš„æœ€å¾Œå¹¾å¥è©±..."
```

**ä¸å¥½çš„ Prompt ç¯„ä¾‹**ï¼ˆæœƒè¢«è½‰éŒ„å‡ºä¾†ï¼‰:
```python
# âŒ æŒ‡ä»¤æ€§æ–‡å­—
prompt="è«‹æº–ç¢ºè½‰éŒ„ï¼Œä¸è¦ç”¢ç”ŸéŒ¯èª¤ã€‚"

# âŒ å…ƒæŒ‡ä»¤
prompt="ä»¥ä¸‹æ˜¯èªéŸ³å…§å®¹ã€‚"

# âŒ é‡è¤‡çš„æç¤ºè©
prompt="ç¹é«”ä¸­æ–‡ç¹é«”ä¸­æ–‡ç¹é«”ä¸­æ–‡"
```

### Token-Based ç‹€æ…‹ç®¡ç†çš„é‡è¦æ€§

ä½¿ç”¨ token ä¾†ç®¡ç†æ¯æ¬¡éŒ„éŸ³ session çš„å¥½è™•ï¼š
1. **è³‡æºéš”é›¢**: æ¯å€‹ session æœ‰ç¨ç«‹çš„è³‡æºï¼ˆqueue, buffer, threadsï¼‰
2. **ä¸¦ç™¼å®‰å…¨**: é¿å…å¤šå€‹ session äº’ç›¸å¹²æ“¾
3. **å¯è¿½è¹¤æ€§**: æ¯å€‹ token å¯ä»¥åœ¨æ—¥èªŒä¸­æ¸…æ¥šè¿½è¹¤
4. **å„ªé›…åœæ­¢**: å¯ä»¥ç²¾ç¢ºåœæ­¢ç‰¹å®š session çš„æ‰€æœ‰è³‡æº

## ğŸ“ ç›¸é—œä»£ç¢¼ä½ç½®

### ä¿®æ”¹çš„æª”æ¡ˆ
- `src/ui/transcription_page.py`
  - Line 326-330: æ·»åŠ é‡è¤‡å•Ÿå‹•æª¢æŸ¥
  - Line 583-591: ç§»é™¤ prompt åƒæ•¸

### å—å½±éŸ¿çš„åŠŸèƒ½
- âœ… èªéŸ³è½‰éŒ„æº–ç¢ºåº¦ï¼ˆæå‡ï¼‰
- âœ… è³‡æºç®¡ç†ï¼ˆæ”¹å–„ï¼‰
- âœ… éŒ¯èª¤æ—¥èªŒå¯è®€æ€§ï¼ˆæ”¹å–„ï¼‰

### æœªå—å½±éŸ¿çš„åŠŸèƒ½
- âœ… VAD éœéŸ³éæ¿¾ï¼ˆä¿æŒä¸è®Šï¼‰
- âœ… å–®ä¸€æª”æ¡ˆè¼¸å‡ºï¼ˆä¿æŒä¸è®Šï¼‰
- âœ… éº¥å…‹é¢¨æ¬Šé™è«‹æ±‚ï¼ˆä¿æŒä¸è®Šï¼‰
- âœ… UI æ›´æ–°é »ç‡æ§åˆ¶ï¼ˆä¿æŒä¸è®Šï¼‰

## ğŸ§ª å¾ŒçºŒæ¸¬è©¦å»ºè­°

### æ¸¬è©¦å ´æ™¯ 1: ä¸€èˆ¬èªéŸ³è½‰éŒ„
- èªªè©± 5 ç§’ â†’ åœé “ 3 ç§’ â†’ èªªè©± 5 ç§’
- é©—è­‰åªæœ‰èªéŸ³éƒ¨åˆ†è¢«è½‰éŒ„
- é©—è­‰ä¸å‡ºç¾ prompt å…§å®¹

### æ¸¬è©¦å ´æ™¯ 2: å¿«é€Ÿé»æ“Šã€Œé–‹å§‹éŒ„éŸ³ã€
- é€£çºŒé»æ“Šã€Œé–‹å§‹éŒ„éŸ³ã€æŒ‰éˆ• 3 æ¬¡
- é©—è­‰åªç”¢ç”Ÿä¸€å€‹ token
- é©—è­‰ console é¡¯ç¤º "Already recording" è¨Šæ¯

### æ¸¬è©¦å ´æ™¯ 3: é•·æ™‚é–“éŒ„éŸ³
- éŒ„éŸ³ 30 ç§’ä»¥ä¸Š
- é©—è­‰æª”æ¡ˆå®Œæ•´æ€§
- é©—è­‰é€å­—ç¨¿å“è³ª

## âœ… ä¿®å¾©å®Œæˆæª¢æŸ¥æ¸…å–®

- [x] ç§»é™¤ Whisper API prompt åƒæ•¸
- [x] æ·»åŠ é‡è¤‡å•Ÿå‹•æª¢æŸ¥
- [x] Python èªæ³•æª¢æŸ¥é€šé
- [x] æ¸…ç†èˆŠæ¸¬è©¦æª”æ¡ˆ
- [x] å‰µå»ºä¿®å¾©æ–‡æª”
- [ ] ç”¨æˆ¶æ¸¬è©¦é©—è­‰

---

**ä¿®å¾©æ—¥æœŸ**: 2025-11-02
**ä¿®å¾©ç‰ˆæœ¬**: v5.2 - Prompt Fix and Duplicate Prevention
**ç‹€æ…‹**: å·²å®Œæˆï¼Œå¾…æ¸¬è©¦
