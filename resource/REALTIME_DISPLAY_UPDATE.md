# 即時顯示與時間軸更新說明

## 📅 更新日期
**2025-11-02**

## ✨ 主要改進

### 1. 即時顯示轉錄結果 ✅
**改進前**: 需要等到錄音結束才能看到完整逐字稿
**改進後**: 錄音過程中，每秒自動更新顯示最新轉錄結果

### 2. 實際時鐘時間軸 ✅
**改進前**: 時間軸顯示相對時間（00:00 開始計算）
**改進後**: 時間軸顯示實際時鐘時間（例如 17:45）

## 📝 即時顯示效果

### 錄音過程中的畫面
```
即時逐字稿（錄音中... 最後更新：17:45:23）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
17:45  歡迎大家來到今天的會議。
17:45  今天我們要討論的主題是語音轉錄技術。
17:45  首先讓我介紹一下 Whisper API 的功能。

📊 已轉錄：87 字元 | 分段數：3
```

**即時更新特點**:
- ✨ 標題顯示「最後更新」時間（精確到秒）
- ✨ 每秒自動刷新頁面
- ✨ 新的轉錄結果會即時出現
- ✨ 不需要等到錄音結束

### 時間軸格式說明

**顯示格式**: `HH:MM  逐字稿內容`

**範例**:
```
17:45  這是 17:45 分轉錄的內容。
17:45  仍然是 17:45 分（因為在同一分鐘內）。
17:46  現在進入 17:46 分了。
17:48  中間有靜音被 VAD 過濾掉，所以跳到 17:48。
```

**特點**:
- 使用 24 小時制（17:45 表示下午 5:45）
- 精確到分鐘（不顯示秒）
- 方便對照實際會議時間
- 可以快速定位「幾點幾分說了什麼」

## 🎯 使用場景

### 場景 1: 會議記錄
```
14:00  會議開始，主席致詞。
14:03  第一位講者報告開始。
14:15  Q&A 環節。
14:30  第二位講者報告。
15:00  會議結束。
```

### 場景 2: 訪談記錄
```
10:30  訪談開始，自我介紹。
10:33  問題一：請問您的工作經驗？
10:36  問題二：您對這個職位的看法？
10:45  訪談結束。
```

### 場景 3: 講座筆記
```
13:00  講座開始，介紹今天的主題。
13:05  第一部分：基礎概念講解。
13:20  第二部分：實際案例分享。
13:40  Q&A 時間。
14:00  講座結束。
```

## 🔧 技術實作

### 即時顯示機制

**自動刷新邏輯** (`src/ui/transcription_page.py:303-308`):
```python
# Auto-refresh every 1 second to show updates more frequently
current_time = time.time()
if current_time - st.session_state.last_ui_update >= 1.0:
    st.session_state.last_ui_update = current_time
    time.sleep(0.1)
    st.rerun()
```

**工作流程**:
1. **Transcription Worker** 每 3 秒產生新轉錄結果
2. 轉錄結果寫入 `_transcript_segments[token]`
3. **UI Thread** 每 1 秒檢查是否需要更新
4. 如果有新內容，立即 `st.rerun()` 重新渲染頁面
5. 用戶看到即時更新的逐字稿

### 時間軸計算

**實際時鐘時間** (`src/ui/transcription_page.py:616`):
```python
# Use actual clock time (HH:MM)
time_str = datetime.now().strftime("%H:%M")

segment_data = {
    "time": time_str,
    "text": transcript.strip()
}
```

**改進前**（相對時間）:
```python
# Calculate relative time from recording start
elapsed_seconds = int(current_time - start_time)
hours = elapsed_seconds // 3600
minutes = (elapsed_seconds % 3600) // 60
time_str = f"{hours:02d}:{minutes:02d}"  # 00:00, 00:03, 00:06...
```

**改進後**（實際時間）:
```python
# Use actual clock time
time_str = datetime.now().strftime("%H:%M")  # 17:45, 17:45, 17:46...
```

### 動態更新指示器

**標題顯示最後更新時間** (`src/ui/transcription_page.py:289-296`):
```python
# Add timestamp to show live updates
last_update_time = datetime.now().strftime("%H:%M:%S")

st.text_area(
    f"即時逐字稿（錄音中... 最後更新：{last_update_time}）",
    value=current_transcript,
    height=300,
    help="格式：時間軸（HH:MM 實際時鐘時間）+ 逐字稿內容 | 每秒自動更新",
    key=f"transcript_live_{token}"
)
```

**作用**:
- 標題會顯示「最後更新：17:45:23」
- 每秒刷新時，這個時間會更新
- 用戶可以清楚看到頁面正在即時更新

## 📊 更新頻率對比

| 項目 | 舊版本 | 新版本 |
|------|--------|--------|
| **轉錄頻率** | 每 3 秒 | 每 3 秒（不變） |
| **UI 更新頻率** | 每 2 秒 | **每 1 秒** ⬆️ |
| **時間軸格式** | 00:00（相對） | **17:45（實際）** ✨ |
| **顯示時機** | 錄音結束後 | **即時顯示** ✨ |
| **更新指示器** | 無 | **最後更新時間** ✨ |

## 💡 優點分析

### 1. 即時反饋
- ✅ 錄音中就能看到轉錄結果
- ✅ 立即發現轉錄錯誤或問題
- ✅ 可以調整說話速度或音量

### 2. 實際時間定位
- ✅ 方便對照會議議程
- ✅ 易於查找特定時間點的內容
- ✅ 適合製作會議紀錄

### 3. 用戶體驗提升
- ✅ 明確的更新指示器
- ✅ 流暢的即時更新
- ✅ 不需要等待就能看到結果

## 🧪 測試步驟

### 測試 1: 即時顯示功能
1. 開始錄音
2. 說話 3 秒（例如：「這是第一句話」）
3. **預期**: 約 3 秒後，文字區塊出現第一段轉錄
4. 繼續說話 3 秒（例如：「這是第二句話」）
5. **預期**: 約 1 秒內，第二段轉錄出現在第一段下方
6. 觀察標題的「最後更新」時間每秒變化

### 測試 2: 實際時鐘時間
1. 記下當前時鐘時間（例如 17:45）
2. 開始錄音並說話
3. **預期**: 轉錄結果顯示「17:45  你的內容」
4. 1 分鐘後繼續說話
5. **預期**: 新的轉錄顯示「17:46  你的內容」

### 測試 3: 長時間錄音
1. 錄音 5 分鐘
2. 觀察時間軸是否正確更新
3. **預期**: 時間軸從 17:45 → 17:46 → ... → 17:50

## 📁 保存的文檔格式

### TXT 文檔範例
```
語音轉錄結果
時間：2025-11-02 17:50:15
音訊檔案：recording-20251102-174500.wav
採樣率：48000 Hz
模型：OpenAI Whisper (whisper-1)
格式：時間軸（HH:MM 實際時鐘時間）+ 逐字稿內容

============================================================

17:45  歡迎大家來到今天的會議。
17:45  今天我們要討論的主題是語音轉錄技術。
17:45  首先讓我介紹一下 Whisper API 的功能。
17:48  Whisper 是 OpenAI 開發的語音識別模型。
17:48  它支援多種語言，包括繁體中文。
17:50  感謝大家的參與，會議結束。
```

## 📝 修改的檔案

### src/ui/transcription_page.py
**修改位置**:
1. **Line 50**: 移除 `_recording_start_time` 變數（不再需要）
2. **Line 289-297**: 添加動態更新指示器和 key 參數
3. **Line 305**: UI 更新頻率從 2 秒改為 1 秒
4. **Line 616**: 時間計算改為實際時鐘時間
5. **Line 664**: 文檔說明更新為實際時鐘時間

## ⚡ 性能考量

### 更新頻率的平衡
- **轉錄頻率**: 3 秒（API 調用成本考量）
- **UI 更新頻率**: 1 秒（用戶體驗考量）

**為什麼不是 0.5 秒？**
- Streamlit rerun 有性能開銷
- 1 秒已經足夠即時
- 避免過度刷新造成閃爍

### 資源使用
- **記憶體**: 輕量級（只儲存文字片段）
- **CPU**: 低負載（只有 UI 更新）
- **網路**: 無額外負擔（Whisper API 調用頻率不變）

## 🎉 完成狀態

- [x] 即時顯示轉錄結果
- [x] 每秒自動更新 UI
- [x] 時間軸使用實際時鐘時間
- [x] 動態更新指示器
- [x] 文檔格式更新
- [x] Python 語法檢查通過

---

**更新版本**: v5.4 - Real-time Display with Clock Time
**狀態**: 已完成
**測試**: 準備測試
